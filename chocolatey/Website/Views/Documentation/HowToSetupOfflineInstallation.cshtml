@{
  ViewBag.Title = "How-To-Setup-Offline-Installation";
}

<article>
<h1 id="how-to-set-up-chocolatey-for-organizationalinternal-use">How To Set Up Chocolatey For Organizational/Internal Use</h1>
<!-- TOC -->
<ul>
<li><a href="#summary">Summary</a></li>
<li><a href="#notes-on-this-guide">Notes on This Guide</a></li>
<li><a href="#references">References</a></li>
<li><a href="#requirements">Requirements</a>
<ul>
<li><a href="#chocolatey-clients">Chocolatey Clients</a>
<ul>
<li><a href="#chocolatey-components">Chocolatey Components</a></li>
<li><a href="#space-requirements">Space Requirements</a></li>
<li><a href="#memory-requirements">Memory Requirements</a></li>
</ul></li>
<li><a href="#chocolatey-repository-servers">Chocolatey Repository Servers</a></li>
<li><a href="#chocolatey-central-management">Chocolatey Central Management</a></li>
</ul></li>
<li><a href="#exercise-0-prepare-for-internal-use">Exercise 0: Prepare For Internal Use</a></li>
<li><a href="#exercise-1-set-up-chocolatey-installation-on-a-machine-without-internet-access">Exercise 1: Set Up Chocolatey Installation On A Machine Without Internet Access</a></li>
<li><a href="#exercise-2-set-up-a-package-repository">Exercise 2: Set Up A Package Repository</a>
<ul>
<li><a href="#exercise-2a-set-up-chocolateyserver">Exercise 2A: Set Up Chocolatey.Server</a>
<ul>
<li><a href="#ensure-chocolateyserver-with-configuration-managers">Ensure Chocolatey.Server with Configuration Managers</a></li>
</ul></li>
<li><a href="#exercise-2b-set-up-a-different-repository">Exercise 2B: Set Up A Different Repository</a></li>
<li><a href="#exercise-2c-set-up-a-file-share-repository">Exercise 2C: Set Up A File Share Repository</a></li>
<li><a href="#exercise-3d-set-up-an-sccm-distribution-point-as-a-chocolatey-source">Exercise 3D: Set Up An SCCM Distribution Point As A Chocolatey Source</a></li>
</ul></li>
<li><a href="#exercise-3-add-packages-to-the-repository">Exercise 3: Add Packages To The Repository</a></li>
<li><a href="#exercise-4-create-a-package-for-the-license">Exercise 4: Create a Package For the License</a></li>
<li><a href="#exercise-5-push-a-package-to-the-repository">Exercise 5: Push A Package To The Repository</a></li>
<li><a href="#exercise-6-installing-chocolatey-on-client-machines">Exercise 6: Installing Chocolatey On Client Machines</a>
<ul>
<li><a href="#exercise-6a-installing-chocolatey-on-clients-directly-using-powershell">Exercise 6A: Installing Chocolatey On Clients Directly Using PowerShell</a></li>
<li><a href="#exercise-6b-installing-chocolatey-on-clients-with-infrastructure-management-tools">Exercise 6B: Installing Chocolatey On Clients with Infrastructure Management Tools</a>
<ul>
<li><a href="#chocolatey-integration-implementation-with-configuration-managers">Chocolatey Integration Implementation with Configuration Managers</a></li>
</ul></li>
</ul></li>
<li><a href="#exercise-7-subscribe-to-release-announcements">Exercise 7: Subscribe To Release Announcements</a></li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#next-steps">Next Steps</a></li>
</ul>
<!-- /TOC -->
<h2 id="summary">Summary</h2>
<p>Most organizations need a Chocolatey environment that does not access the internet. Fortunately, Chocolatey is a fully offline solution, we&#39;ll just need to remove the default community repository and point it to internal repositories. This walkthrough will provide you everything you need to get setup. We also have steps in this walkthrough that deal with environments that are air gapped (no access to the internet).</p>
<blockquote>
<p>Chocolatey best practices for organizations / internal use:</p>
<ul>
<li>Set up one or more internal repositories</li>
<li>Bring all external packages you need in and internalize (not cache) any that download anything at runtime</li>
<li>Configure Chocolatey clients for internal use - config and removal of community package repository source</li>
<li>Create packages with resources embedded in the package - this makes for reliable, repeatable use of Chocolatey (the community repository must download at runtime due to being publicly available which means distribution rights, internal use is not subject to distribution rights)</li>
<li>Do not use the community repository. It is not fully reliable due to a required dependence on the internet at runtime.</li>
<li>Learn when new Chocolatey releases are out - register with the release announcements mailing list</li>
</ul>
</blockquote>
<h2 id="notes-on-this-guide">Notes on This Guide</h2>
<p>This guide is pretty much the essential how to guide to having a successful internal Chocolatey deployment. What you will find below are walkthrough steps and scripts (!!) to really help speed up that initial setup. Some (most) of what you will find here is not meant to be automated past what is already here, most are one-time things that need to be performed, so they don&#39;t lend themselves well to being automated further than they already are with the scripts here.</p>
<p>That said, Exercises 2 and 6 do lend themselves well to automation with infrastructure management (configuration management) tools. You will find that Puppet likely has the most comprehensive set of ability to fully configure Chocolatey and Chocolatey.Server, with PowerShell DSC coming in there as well. Most configuration management tools do support managing the installation of Chocolatey and software packages, but side step Chocolatey configuration. We think that they should do more there, and we find it&#39;s best if you reach out to those folks to ask that they would support those things.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://chocolatey.org/install#completely-offline-install">Offline Chocolatey Install</a></li>
<li><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "installation-licensed" })">Licensed Install</a></li>
<li><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-host-feed" })">Host Your Own Package Server</a></li>
<li><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-set-up-chocolatey-server" })">Set up Chocolatey Server</a></li>
<li><a href="https://chocolatey.org/security">Security</a></li>
<li><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "community-packages-disclaimer" })">Community Package Repository Disclaimer</a></li>
</ul>
<h2 id="requirements">Requirements</h2>
<h3 id="chocolatey-clients">Chocolatey Clients</h3>
<p>With Chocolatey clients, we ensure that Chocolatey is going to run with low memory footprints because you will have all aspects of things you will need to manage and different space and memory available across all of those clients. Chocolatey has a very wide reach into where it can be installed.</p>
<p>For Chocolatey clients, you will need the following:</p>
<ul>
<li>Windows 7+/Windows 2003+ (Server Core also, but not Windows Nano Server)</li>
<li>Windows PowerShell v2+ (not PowerShell Core)</li>
<li>.NET Framework 4.x+</li>
</ul>
<h4 id="chocolatey-components">Chocolatey Components</h4>
<ul>
<li>Chocolatey CLI aka choco (or choco.exe) is a client (not a Windows service) that provides the core of Chocolatey and the installation store for locally installed packages. This is important as Chocolatey manages packages, not Programs and Features directly - Programs and Features is limited only to software that has &quot;installers&quot; and Chocolatey treats all aspects of Windows software as first class citizens (zips, scripts, binaries, installers), thus it needs to track and manage those things separately.</li>
<li>Chocolatey GUI is an application that runs when a user runs it (also not a Windows Service).</li>
<li>Chocolatey Agent (aka chocolatey-agent) is a Windows service available in Chocolatey for Business. It is used for <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "features-agent-service" })">Self-Service Installation</a> and Chocolatey Central Management.</li>
</ul>
<h4 id="space-requirements">Space Requirements</h4>
<ul>
<li>Chocolatey CLI has an impact of 15 MB on default install plus the space the installed packages use up.</li>
<li>Chocolatey GUI takes up another 50–100 MB of space on default installation.</li>
<li>Chocolatey Agent (aka chocolatey-agent) is a Windows service available in Chocolatey for Business - it has an impact of about 10 MB.</li>
</ul>
<p><strong>RECOMMENDATION</strong>: We recommend enough free space for the applications you will install plus another 1 GB for allowing Chocolatey to process that. You will want to turn on Package Reducer (commercial editions) if you have it to really reduce the impact of embedded packages, which bring reliability but also increase footprint (unless you have Package Reducer). If you don&#39;t have Package Reducer and you are embedding binaries into nupkgs, you will need 3 times the space of what you are installing unless you explicitly clean up the extracted installers/zips in your automated scripts - then you will need 2x the space when considering the nupkg will still contain embedded binaries (and the nupkg must stick around). Unfortunately, this is going to be a calculation to understand exact space requirements and it really depends on what you will install.</p>
<h4 id="memory-requirements">Memory Requirements</h4>
<ul>
<li>Chocolatey CLI only runs when called. It falls into managed memory thus can work in environments with low amounts of memory provided that they have enough memory available to manage software installations.</li>
<li>Chocolatey GUI only runs when the application is open and is also in managed memory. It can work on systems with low amounts of memory.</li>
<li>Chocolatey Agent (aka chocolatey-agent) - it is always running but has a very low footprint unless it is processing something.</li>
</ul>
<p><strong>RECOMMENDATION</strong>: At least 2GB of RAM at a bare minimum, but recommend at least 8GB for managing installations.</p>
<h3 id="chocolatey-repository-servers">Chocolatey Repository Servers</h3>
<p>Unforunately it&#39;s harder to make recommendations here as it is really dependent on the repository that you choose and what requirements they have. It varies from a Windows deployment to Linux deployed repositories, from Java-based, to .NET-based, to PHP, and Rust-based repositories. The requirements vary wildly, plus you may use those repositories that address multiple types of packages and would need to figure out the space available for that.</p>
<p><strong>SPACE RECOMMENDATION</strong>: Have enough space for 10x the size of the installers and other software you will store. This will allow for some default growth. We would recommend 100 GB at a minimum.</p>
<h3 id="chocolatey-central-management">Chocolatey Central Management</h3>
<p>Requirements coming soon. Just imagine normal recommendations for an ASP.NET IIS deployment, a SQL Server back end, and 1+ Windows Services (depending on scale).</p>
<h2 id="exercise-0-prepare-for-internal-use">Exercise 0: Prepare For Internal Use</h2>
<p>The first thing we need to do is prepare. To do that we need a Windows machine with internet access so it can gather everything. If you are setting up into an air gapped network, you will be completing this on one machine, then loading it to a USB or to something else to get it over to the air gapped network (which we&#39;ll set up in Exercise 1). Check with your security teams to see if you have other steps that need to be completed prior to taking files from internet sources to the air gapped network.</p>
<p>From the machine with internet access:</p>
<ol>
<li>Open PowerShell.exe as an administrative shell. You can type &quot;Windows Key + X + A&quot; (Windows 8+ - when that comes up if it is cmd.exe, simply type <code>powershell</code> to get into it).</li>
<li>Type <code>cd /</code> and hit enter.</li>
<li>Type <code>New-Item -Path &quot;$env:SystemDrive\choco-setup&quot; -ItemType Directory -Force</code> and enter followed by <code>cd choco-setup</code> and enter.</li>
<li>In <code>c:\choco-setup</code>, type <code>New-Item -Path &quot;$env:SystemDrive\choco-setup\files&quot; -ItemType Directory -Force</code> and press enter.</li>
<li>In <code>c:\choco-setup</code>, type <code>New-Item -Path &quot;$env:SystemDrive\choco-setup\packages&quot; -ItemType Directory -Force</code> and press enter.</li>
<li>Type <code>cd packages</code> and press enter.</li>
<li>Now run <code>Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))</code> (this will get Chocolatey installed and it is what you see at <a href="https://chocolatey.org/install" class="uri">https://chocolatey.org/install</a>). It also makes choco available in that current shell. If you run into proxy issues here, please see <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "proxy-settings-for-chocolatey" })">installing Chocolatey behind a proxy server</a>.</li>
<li>C4B / MSP / TRIAL: Obtain the <code>chocolatey.license.xml</code> from the email sent from the Chocolatey team and save the license file to <code>c:\choco-setup\files</code> so we can use it here and on the offline machines.</li>
<li>TRIAL: grab a copy of the two nupkgs from the email. If you don&#39;t have that email with the download links, request it from whoever provided you the trial license. Save those two packages to <code>c:\choco-setup\packages</code>.</li>
<li>C4B / MSP / TRIAL: Run this command <code>New-Item $env:ChocolateyInstall\license -ItemType Directory -Force</code> - this creates the license directory.</li>
<li>C4B / MSP / TRIAL: Copy the license file (&quot;chocolatey.license.xml&quot;) into that folder that was just created. Run <code>Copy-Item &quot;$env:SystemDrive\choco-setup\files\chocolatey.license.xml&quot; $env:ChocolateyInstall\license\chocolatey.license.xml -Force</code>.</li>
<li>C4B / MSP / TRIAL: Verify the license is recognized - run choco. You should see something like &quot;Chocolatey v0.10.8 Business&quot;. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and we can ignore that for now.</li>
<li>C4B / MSP: Run <code>choco upgrade chocolatey.extension -y</code>. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and should clear up when this command completes.</li>
<li>TRIAL: Run <code>choco upgrade chocolatey.extension --pre --source c:\choco-setup\packages</code> (this is where you saved the nupkgs earlier).</li>
<li>Run <code>choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache</code>. This moves the TEMP location in scripts to use this and makes clean up more deterministic.</li>
<li>Run <code>choco config set commandExecutionTimeoutSeconds 14400</code>. This increases the timeout more than the default 45 minutes, you may wish to set it higher.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'internalizeAppendUseOriginalLocation'&quot;</code>. This sets Package Internalizer to append <code>-UseOriginalLocation</code> to the end of <code>Install-ChocolateyPackage</code> to make it behave more like <code>Install-ChocolateyInstallPackage</code>. Since the files are local, we won&#39;t need it copying them to temp prior to running it.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'reduceInstalledPackageSpaceUsage'&quot;</code> to ensure Package Reducer is turned on.</li>
<li>Set proxy configuration, virus scan configuration, or other configuration as described at <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "chocolatey-configuration" })">Chocolatey configuration</a>.</li>
<li>C4B / MSP / TRIAL: Are we installing the <a href="https://chocolatey.org/docs/features-agent-service#setup">optional Chocolatey Agent Service as well</a>? If so, run <code>choco upgrade chocolatey-agent -y --pre</code> and then follow the link for other settings you will need to configure.</li>
<li>Download packages (choose one):<br />
* C4B / MSP / TRIAL: - Run the following: <code>choco download chocolatey chocolatey.server dotnet4.6.1 chocolateygui --internalize</code>. This is going to take quite awhile.<br />
* FOSS only - download the following packages:<br />
* <a href="https://chocolatey.org/api/v2/package/chocolatey">Chocolatey</a><br />
* <a href="https://chocolatey.org/api/v2/package/chocolateygui">Chocolatey GUI</a><br />
* Download Chocolatey.Server package and dependencies:<br />
* <a href="https://chocolatey.org/api/v2/package/chocolatey.server">Chocolatey.Server</a><br />
* <a href="https://chocolatey.org/api/v2/package/DotNet4.6">dotnet4.6</a> - <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">internalize manually</a><br />
* <a href="https://chocolatey.org/api/v2/package/DotNet4.6.1">dotnet4.6.1</a> - <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">internalize manually</a><br />
* <a href="https://chocolatey.org/api/v2/package/KB2919355">KB2919355</a> - <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">internalize manually</a><br />
* <a href="https://chocolatey.org/api/v2/package/KB2919442">KB2919442</a> - <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">internalize manually</a></li>
<li>C4B / MSP - Run the following additionally: <code>choco download chocolatey.extension chocolatey-agent --internalize</code>. TRIAL - you should already have placed these nupkgs in the folder earlier.</li>
<li>Now we should have several packages in <code>c:\choco-setup\packages</code>. If not, type <code>start .</code> and go copy the files here to that location.</li>
<li>Obtain the PowerShell script from <a href="https://chocolatey.org/install#completely-offline-install" class="uri">https://chocolatey.org/install#completely-offline-install</a> and copy it to <code>c:\choco-setup\files</code> as &quot;ChocolateyLocalInstall.ps1&quot;. We will need this to install Chocolatey on the airgapped box.</li>
<li>Open <code>c:\choco-setup\files\ChocolateyLocalInstall.ps1</code> in an editor like Notepad++ or Visual Studio Code (do not use Notepad.exe!!).</li>
<li>Change this line <code>$localChocolateyPackageFilePath = 'c:\packages\chocolatey.0.10.0.nupkg'</code> to <code>$localChocolateyPackageFilePath = 'c:\choco-setup\packages\chocolatey.0.10.8.nupkg'</code> (adjust for the actual path to the Chocolatey package).</li>
<li>Air Gapped Networks: Get those files over to that air gapped network (USB key and sneakernet if you need to).</li>
</ol>
<p>Here is a handy script you can use for MSP/C4B (FOSS, adjust appropriately):</p>
<pre><code class="powershell"># Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force

# Setting up directories for values
New-Item -Path &quot;$env:SystemDrive\choco-setup&quot; -ItemType Directory -Force
New-Item -Path &quot;$env:SystemDrive\choco-setup\files&quot; -ItemType Directory -Force
New-Item -Path &quot;$env:SystemDrive\choco-setup\packages&quot; -ItemType Directory -Force

# Install Chocolatey
iex ((New-Object System.Net.WebClient).DownloadString(&#39;https://chocolatey.org/install.ps1&#39;))

# Are you military, government, or for some other reason have FIPS compliance turned on?
#choco feature enable --name=&quot;&#39;useFipsCompliantChecksums&#39;&quot;

# Add license to setup and to local install
New-Item $env:ChocolateyInstall\license -ItemType Directory -Force
Write-Host &quot;Please add chocolatey.license.xml to &#39;$env:SystemDrive\choco-setup\files&#39;.&quot;
Write-Host &#39;Once you do so, press any key to continue...&#39;;
$null = $Host.UI.RawUI.ReadKey(&#39;NoEcho,IncludeKeyDown&#39;);
Copy-Item $env:SystemDrive\choco-setup\files\chocolatey.license.xml $env:ChocolateyInstall\license\chocolatey.license.xml -Force

# Install Chocolatey Licensed Extension
choco upgrade chocolatey.extension -y --pre
Write-Host &quot;If you see what looks like an error about a missing extension, that is what this step does so it will clear up on next command.&quot;
# TRIAL: Place nupkgs into the &quot;$env:SystemDrive\choco-setup\packages&quot; directory (add a script here to do so)
# TRIAL: Run this instead: choco upgrade chocolatey.extension --pre --source c:\choco-setup\packages

# Set Configuration
choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache
choco config set commandExecutionTimeoutSeconds 14400
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration

# Set Licensed Configuration
choco feature enable --name=&quot;&#39;internalizeAppendUseOriginalLocation&#39;&quot;
choco feature enable --name=&quot;&#39;reduceInstalledPackageSpaceUsage&#39;&quot;
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration

#TODO: Are we installing the Chocolatey Agent Service?
# https://chocolatey.org/docs/features-agent-service#setup
# choco upgrade chocolatey-agent -y --pre
#choco feature disable --name=&quot;&#39;showNonElevatedWarnings&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundService&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundServiceWithNonAdministratorsOnly&#39;&quot;
#TODO: Check out other options and features to set at the url above.
#TODO: Also make sure you set your sources to allow for self-service

# Download and internalize packages.
choco download chocolatey chocolatey.server dotnet4.6.1 chocolateygui --internalize --output-directory=&quot;$env:SystemDrive\choco-setup\packages&quot; --source=&quot;&#39;https://chocolatey.org/api/v2/&#39;&quot;
# TRIAL: skip this next step
choco download chocolatey.extension chocolatey-agent --internalize --output-directory=&quot;$env:SystemDrive\choco-setup\packages&quot; --source=&quot;&#39;https://licensedpackages.chocolatey.org/api/v2/&#39;&quot; # will fail on trial

# Download local install script - need at least PowerShell v3
$installScript = iwr -UseBasicParsing -Uri https://gist.githubusercontent.com/ferventcoder/d0aa1703a7d302fce79e7a4cc13797c0/raw/b1f7bad2441fa6c371b48b8475ef91cecb4d6370/ChocolateyLocalInstall.ps1 -UseDefaultCredentials
$installScript | Out-File -FilePath &quot;$env:SystemDrive\choco-setup\files\ChocolateyLocalInstall.ps1&quot; -Encoding UTF8 -Force
Write-Warning &quot;Check and adjust script at &#39;$env:SystemDrive\choco-setup\files\ChocolateyLocalInstall.ps1&#39; to ensure it points to the right version of Chocolatey in the choco-setup\packages folder.&quot;</code></pre>
<h2 id="exercise-1-set-up-chocolatey-installation-on-a-machine-without-internet-access">Exercise 1: Set Up Chocolatey Installation On A Machine Without Internet Access</h2>
<p>Now that we&#39;ve finished the first exercise and have those files over on our offline Windows machine, we need to get Chocolatey set up on this machine as well. This could be ultimately be a Chocolatey.Server Repository, or it could be something else. Note: <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-host-feed" })">Other repository servers don&#39;t necessarily require Windows</a>.</p>
<p><strong>NOTE:</strong> If you are using the same machine from Exercise 0 for setting up your repository, you can skip this Exercise and go to Exercise 2 (in other words, your machine already has Chocolatey installed).</p>
<ol>
<li>Ensure the folders from the other drive are set in <code>c:\choco-setup</code> here on this machine (should match with where things were set in Exercise 0).</li>
<li>Open PowerShell.exe as an administrative shell. You can type &quot;Windows Key + X + A&quot; (Windows 8+ - when that comes up if it is cmd.exe, simply type <code>powershell</code> to get into it).</li>
<li>Type <code>&amp; $env:SystemDrive\choco-setup\files\ChocolateyLocalInstall.ps1</code> and press enter. This should install Chocolatey if you have everything set up correctly from the first set of instructions.</li>
<li>Run <code>choco source remove --name=&quot;'chocolatey'&quot;</code>. This removes the default Chocolatey source.</li>
<li>Run <code>choco source add --name=&quot;'setup'&quot; --source=&quot;'$env:SystemDrive\choco-setup\packages'&quot;</code></li>
<li>C4B / MSP / TRIAL: Run this command <code>New-Item $env:ChocolateyInstall\license -ItemType Directory -Force</code> - this creates the license directory.</li>
<li>C4B / MSP / TRIAL: Copy the license file (&quot;chocolatey.license.xml&quot;) into that folder that was just created. Run <code>Copy-Item &quot;$env:SystemDrive\choco-setup\files\chocolatey.license.xml&quot; $env:ChocolateyInstall\license\chocolatey.license.xml -Force</code>.</li>
<li>C4B / MSP / TRIAL: Run <code>choco source disable --name=&quot;'chocolatey.licensed'&quot;</code>. When the license is placed, Chocolatey automatically adds the license and we don&#39;t want to use that source. Note we can&#39;t remove the license because the existence of the license file will have Chocolatey adding it right back - so we just disable it. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and we are going to take care of that in the next step.</li>
<li>C4B / MSP / TRIAL: Run <code>choco upgrade chocolatey.extension -y --pre</code>. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and should clear up when this command completes.</li>
<li>Run <code>choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache</code>. This moves the TEMP location in scripts to use this and makes clean up more deterministic.</li>
<li>Run <code>choco config set commandExecutionTimeoutSeconds 14400</code>. This increases the timeout more than the default 45 minutes, you may wish to set it higher.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'internalizeAppendUseOriginalLocation'&quot;</code>. This sets Package Internalizer to append <code>-UseOriginalLocation</code> to the end of <code>Install-ChocolateyPackage</code> to make it behave more like <code>Install-ChocolateyInstallPackage</code>. Since the files are local, we won&#39;t need it copying them to temp prior to running it.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'reduceInstalledPackageSpaceUsage'&quot;</code> to ensure Package Reducer is turned on.</li>
<li>Set proxy configuration, virus scan configuration, or other configuration as described at <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "chocolatey-configuration" })">Chocolatey configuration</a>.</li>
<li>C4B / MSP / TRIAL: Are we installing the <a href="https://chocolatey.org/docs/features-agent-service#setup">optional Chocolatey Agent Service as well</a>? If so, run <code>choco upgrade chocolatey-agent -y --pre</code> and then follow the link for other settings you will need to configure.</li>
</ol>
<pre><code class="powershell"># Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey
&amp; $env:SystemDrive\choco-setup\files\ChocolateyLocalInstall.ps1

# Are you military, government, or for some other reason have FIPS compliance turned on?
#choco feature enable --name=&quot;&#39;useFipsCompliantChecksums&#39;&quot;

# Sources - Remove community repository and add a local folder source
choco source remove --name=&quot;&#39;chocolatey&#39;&quot;
choco source add --name=&quot;&#39;local&#39;&quot; --source=&quot;&#39;$env:SystemDrive\choco-setup\packages&#39;&quot;

# Add license to setup and to local install
New-Item &quot;$env:ChocolateyInstall\license&quot; -ItemType Directory -Force
Copy-Item -Path &quot;$env:SystemDrive\choco-setup\files\chocolatey.license.xml&quot; -Destination &quot;$env:ChocolateyInstall\license\chocolatey.license.xml&quot; -Force

# Sources - Disable licensed source
choco source disable --name=&quot;&#39;chocolatey.licensed&#39;&quot;
Write-Host &quot;You can ignore the red text in the output above, as it is more of a warning until we have chocolatey.extension installed&quot;

# Install Chocolatey Licensed Extension
choco upgrade chocolatey.extension -y --pre

# Set Configuration
choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache
choco config set commandExecutionTimeoutSeconds 14400
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration

# Set Licensed Configuration
choco feature enable --name=&quot;&#39;internalizeAppendUseOriginalLocation&#39;&quot;
choco feature enable --name=&quot;&#39;reduceInstalledPackageSpaceUsage&#39;&quot;
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration


#TODO: Are we installing the Chocolatey Agent Service?
# https://chocolatey.org/docs/features-agent-service#setup
# choco upgrade chocolatey-agent -y --pre
#choco feature disable --name=&quot;&#39;showNonElevatedWarnings&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundService&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundServiceWithNonAdministratorsOnly&#39;&quot;
#TODO: Check out other options and features to set at the url above.
#TODO: Also make sure you set your sources to allow for self-service</code></pre>
<h2 id="exercise-2-set-up-a-package-repository">Exercise 2: Set Up A Package Repository</h2>
<p>Now we have a machine where we have Chocolatey installed and configured, and we have the setup files we gathered in Exercise 0. So now we are going to set up a package repository for use for all of our clients - this is where you will push packages and get packages from with your Chocolatey clients. Some repositories do not require Windows as part of their setup (Artifactory Pro and Nexus come to mind, but there are others). In choosing what you will use, it&#39;s good to read over <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-host-feed" })">set up a package repository</a> to learn about the advantages and disadvantages of each. Pick one or more of the following paths:</p>
<ul>
<li><a href="#exercise-2a-set-up-chocolateyserver">Set Up Chocolatey.Server</a></li>
<li><a href="#exercise-2b-set-up-a-different-repository">Set Up A Different Repository</a></li>
<li><a href="#exercise-2c-set-up-a-file-share-repository">Set Up A File Share Repository</a></li>
<li><a href="#exercise-3d-set-up-an-sccm-distribution-point-as-a-chocolatey-source">Set Up An SCCM Distribution Point As A Chocolatey Source</a></li>
</ul>
<h3 id="exercise-2a-set-up-chocolateyserver">Exercise 2A: Set Up Chocolatey.Server</h3>
<p><strong>NOTE:</strong> If you have an IIS site for WSUS administration, Chocolatey.Server website will not come up at all, even if everything looks right. We have not yet been able to determine the issue, but believe it is related to ASP.NET 4.6+. Installing all of the required components for Chocolatey.Server may also affect your WSUS admin site. Please seek a different box.</p>
<p>Since we put the items on this machine in the previous exercise, we can just pick up where we left off.</p>
<ol>
<li>Finish Exercise 0/1 on a machine you will set up as a server.</li>
<li>Follow the steps at <a href="https://chocolatey.org/docs/how-to-set-up-chocolatey-server#setup-normally" class="uri">https://chocolatey.org/docs/how-to-set-up-chocolatey-server#setup-normally</a></li>
<li>Follow the steps at <a href="https://chocolatey.org/docs/how-to-set-up-chocolatey-server#additional-configuration" class="uri">https://chocolatey.org/docs/how-to-set-up-chocolatey-server#additional-configuration</a></li>
<li>Open a web browser and navigate to <a href="http://localhost" class="uri">http://localhost</a>. Read over the site and take notes.</li>
<li>Change the API key in the web.config file following the instructions at <a href="http://localhost" class="uri">http://localhost</a>. If localhost doesn&#39;t resolve to the site, make sure the bindings include &quot;All Unassigned&quot;. This could be a temporary change if you need it to be, but it&#39;s important to access this to see additional setup instructions. <strong>NOTE</strong>: Use a real editor, like Notepad++ when working with text files like the web.config. Do NOT, I repeat, DO NOT use notepad.exe.</li>
<li>You may wish to install an SSL certificate.</li>
<li>You may wish to set up authentication to the repository (the SSL certificate is highly recommended to not pass passwords in cleartext).</li>
</ol>
<p><strong>NOTE</strong>: It is important that you do not end with the default apikey in the web.config, as that is easily found. That would leave your install insecure in that anyone in your organization would be able to push packages. You want to keep that down to approved folks.</p>
<blockquote>
<p>Best practices with Chocolatey.Server:</p>
<ul>
<li>Change the ApiKey in the web.config file</li>
<li>Set up basic auth to restrict usage to approved folks (see the web.config for instructions)</li>
<li>Use SSL if accessible from the internet</li>
<li>Store the Chocolatey nupkg and other packages from Chocolatey Software on this server (next exercise covers this)</li>
</ul>
</blockquote>
<p><strong>NOTE:</strong> Chocolatey.Server is a one package repository per setup and only has one apikey that can be used. So if you need multiple repositories, you would setup multiple Chocolatey.Server instances to cover your needs. Another option when you need multiple repositories and want ease of management is to look into Artifactory Pro, Nexus, and ProGet. They not only have multiple Chocolatey/NuGet repositories per instance, but also other repositories types as well. See the next section.</p>
<pre><code class="powershell"># Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force

# Install Chocolatey.Server
choco upgrade chocolatey.server -y --pre

Write-Warning &quot;Follow the steps at https://chocolatey.org/docs/how-to-set-up-chocolatey-server#setup-normally and  https://chocolatey.org/docs/how-to-set-up-chocolatey-server#additional-configuration for now.&quot;
# more may be added later</code></pre>
<h4 id="ensure-chocolateyserver-with-configuration-managers">Ensure Chocolatey.Server with Configuration Managers</h4>
<ul>
<li>Puppet has an automated way of managing a Chocolatey.Server setup (it may not be up to date as of this writing). See <a href="https://forge.puppet.com/chocolatey/chocolatey_server" class="uri">https://forge.puppet.com/chocolatey/chocolatey_server</a>.</li>
<li>Ansible has a blog post at <a href="http://frostbyte.us/using-ansible-to-install-a-chocolatey-package-repository/" class="uri">http://frostbyte.us/using-ansible-to-install-a-chocolatey-package-repository/</a> with some things we&#39;d love to see wrapped into a module.</li>
<li>Chef has a POC at <a href="https://github.com/galenemery/chocolatey_server" class="uri">https://github.com/galenemery/chocolatey_server</a></li>
<li>Docker image at - <a href="https://github.com/takhyon/docker-chocolatey.server" class="uri">https://github.com/takhyon/docker-chocolatey.server</a>. Disclaimer: This is not a recommendation - we have no affiliation nor have we verified this</li>
</ul>
<h3 id="exercise-2b-set-up-a-different-repository">Exercise 2B: Set Up A Different Repository</h3>
<p>If you are setting up something different than Chocolatey.Server, you may wish to read over <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-host-feed" })">How To Set Up an Internal Repository</a>. This will give you options and links to repositories like Artifactory Pro, Nexus, and ProGet. <strong>NOTE</strong>: Some repository server options don&#39;t require Windows.</p>
<p><strong>NOTE:</strong> Many repositories have a concept of a proxy repository. Unlike NuGet repositories, you likely <strong><em>DO NOT WANT</em></strong> a proxied NuGet/Chocolatey repository pointing to the community repository. They only cache packages - <strong><em>cached</em> is not the same concept as <em>internalized</em></strong>. To reuse packages from the community repository in a reliable way, you need to <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">internalize them</a>. The community repository is subject to distribution rights, which means many packages need to download things from the internet at <strong><em>runtime</em></strong>. That&#39;s unreliable and a no go for many organizations. You can use Package Internalizer (as we are seeing above) or <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "how-to-recompile-packages" })">manually internalize packages</a> you want to use from the community repository. More on <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "community-packages-disclaimer" })">why (community packages repository notes)</a>.</p>
<h3 id="exercise-2c-set-up-a-file-share-repository">Exercise 2C: Set Up A File Share Repository</h3>
<p>Setting up a file share repository is typically quite simple. You put your nupkgs into a flat folder structure (no subfolders currently) and then can access them wherever you can reach the file share. However there are a couple of things to keep in mind and be careful with when it comes to file shares as repositories. File shares can be UNC, DFS, SMB, etc, as long as it supports Windows ACL permissions.</p>
<blockquote>
<p>File Share notes:</p>
<ul>
<li>ACL/Share permissions should not let anyone put packages in the share</li>
<li>ACLs control access to read permissions.</li>
<li>Packages go into the share folder, not subfolders (Chocolatey is currently based in NuGet v2, which doesn&#39;t allow subfolders)</li>
<li>Be very careful never to overwrite a version of a nupkg, especially if it has been deployed to any clients. See <a href="https://chocolatey.org/docs/how-to-host-feed#package-version-immutability">package immutability</a></li>
<li>Bigger-sized packages will slow down queries, so explore a different option when you see that. Migration is easy</li>
<li>Set access properly if you need to connect from local machine accounts, Everyone share access does not give them network permission. See <a href="https://chocolatey.org/docs/how-to-host-feed#local-folder-permissions">local share permissions</a>.</li>
</ul>
</blockquote>
<p><strong>NOTE:</strong> If you run into issues where Chocolatey can&#39;t see the packages, check the last point above.</p>
<p>While setting up a file share is the quickest way to get started, you may find you outgrow it quite quickly. Fortunately migration to another repository is very simple.</p>
<h3 id="exercise-3d-set-up-an-sccm-distribution-point-as-a-chocolatey-source">Exercise 3D: Set Up An SCCM Distribution Point As A Chocolatey Source</h3>
<p>We won&#39;t go into how to set up a distribution point, as you have places to learn how to set those up. To enable a distribution point, you are going to add a file share to it. Follow the previous exercise.</p>
<h2 id="exercise-3-add-packages-to-the-repository">Exercise 3: Add Packages To The Repository</h2>
<ol>
<li>Now we need to get the packages we have in <code>c:\choco-setup\packages</code> to the package repository. With Chocolatey.Server, we can cheat a little and simply copy the nupkg files to <code>$env:ChocolateyToolsLocation\Chocolatey.Server\App_Data\Packages</code>.</li>
<li>If we are using a different repository, we just need to run <code>choco push &lt;nupkg_path&gt; -s http://&lt;url_to_api&gt; -k &lt;apikey&gt;</code></li>
</ol>
<p><strong>NOTE:</strong> We&#39;ll put Chocolatey here, and use this location of Chocolatey for all further client installations. If we are using Chocolatey.Server, we&#39;ll have an install.ps1 that it serves that is dynamic and will use a local chocolatey.nupkg if we have one in the repository (it will use the Chocolatey package at <a href="https://chocolatey.org/" class="uri">https://chocolatey.org/</a> otherwise, which we won&#39;t want).</p>
<p>Here is a script for Chocolatey.Server:</p>
<pre><code class="powershell"># Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force

# Copy the packages to the Chocolatey.Server repo folder
Copy-Item &quot;$env:SystemDrive\choco-setup\packages\*&quot; -Destination &quot;$env:ChocolateyToolsLocation\Chocolatey.Server\App_Data\Packages\&quot; -Force -Recurse

# Copy the license to the Chocolatey.Server repo (for v0.2.3+ downloads)
#New-Item &quot;$env:ChocolateyToolsLocation\Chocolatey.Server\App_Data\Downloads&quot; -ItemType Directory -Force
#Copy-Item &quot;$env:SystemDrive\choco-setup\files\chocolatey.license.xml&quot; -Destination &quot;$env:ChocolateyToolsLocation\Chocolatey.Server\App_Data\Downloads\chocolatey.license.xml&quot; -Force -Recurse</code></pre>
<p>For other things, just loop over the nupkg files and call <code>choco push</code>.</p>
<h2 id="exercise-4-create-a-package-for-the-license">Exercise 4: Create a Package For the License</h2>
<p><strong>NOTE</strong>: This is for C4B / MSP / TRIAL ONLY.<br />
To make things easier for deployments, let&#39;s create a package for the license file. We are going to grab the currently installed license to do this, but you could use the one in <code>c:\choco-setup\files</code>.</p>
<p>Save this script and run it on a machine where you&#39;ve installed the license.</p>
<pre><code class="powershell"># Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force

$licenseLocation = &quot;$env:ChocolateyInstall\license\chocolatey.license.xml&quot;
$packagingFolder = &quot;$env:SystemDrive\choco-setup\packaging&quot;
$packagesFolder = &quot;$env:SystemDrive\choco-setup\packages&quot;
$packageId = &quot;chocolatey-license&quot;
$licensePackageFolder = &quot;$packagingFolder\$packageId&quot;
$licensePackageNuspec = &quot;$licensePackageFolder\$packageId.nuspec&quot;

# Ensure the packaging folder exists
Write-Output &quot;Generating package/packaging folders at &#39;$packagingFolder&#39;&quot;
New-Item $packagingFolder -ItemType Directory -Force | Out-Null
New-Item $packagesFolder -ItemType Directory -Force | Out-Null

# Create a new package
Write-Output &quot;Creating package named  &#39;$packageId&#39;&quot;
New-Item $licensePackageFolder -ItemType Directory -Force | Out-Null
New-Item &quot;$licensePackageFolder\tools&quot; -ItemType Directory -Force | Out-Null

# Set the installation script
Write-Output &quot;Setting install and uninstall scripts...&quot;
@@&quot;
`$ErrorActionPreference = &#39;Stop&#39;
`$toolsDir              = &quot;`$(Split-Path -parent `$MyInvocation.MyCommand.Definition)&quot;
`$licenseFile           = &quot;`$toolsDir\chocolatey.license.xml&quot;

New-Item &quot;`$env:ChocolateyInstall\license&quot; -ItemType Directory -Force
Copy-Item -Path `$licenseFile  -Destination `$env:ChocolateyInstall\license\chocolatey.license.xml -Force
Write-Output &quot;The license has been installed.&quot;
&quot;@@ | Out-File -FilePath &quot;$licensePackageFolder\tools\chocolateyInstall.ps1&quot; -Encoding UTF8 -Force

# Set the uninstall script
@@&quot;
Remove-Item -Path &quot;`$env:ChocolateyInstall\license\chocolatey.license.xml&quot; -Force
Write-Output &quot;The license has been removed.&quot;
&quot;@@ | Out-File -FilePath &quot;$licensePackageFolder\tools\chocolateyUninstall.ps1&quot; -Encoding UTF8 -Force

# Copy the license to the package directory
Write-Output &quot;Copying license to package from &#39;$licenseLocation&#39;...&quot;
Copy-Item -Path $licenseLocation  -Destination &quot;$licensePackageFolder\tools\chocolatey.license.xml&quot; -Force

# Set the nuspec
Write-Output &quot;Setting nuspec...&quot;
@@&quot;
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;package xmlns=&quot;http://schemas.microsoft.com/packaging/2015/06/nuspec.xsd&quot;&gt;
  &lt;metadata&gt;
    &lt;id&gt;chocolatey-license&lt;/id&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
    &lt;!--&lt;owners&gt;__REPLACE_YOUR_NAME__&lt;/owners&gt;--&gt;
    &lt;title&gt;Chocolatey License&lt;/title&gt;
    &lt;authors&gt;__REPLACE_AUTHORS_OF_SOFTWARE_COMMA_SEPARATED__&lt;/authors&gt;
    &lt;tags&gt;chocolatey license&lt;/tags&gt;
    &lt;summary&gt;Installs the Chocolatey commercial license file.&lt;/summary&gt;
    &lt;description&gt;This package ensures installation of the Chocolatey commercial license file.

This should be installed internally prior to installing other packages, directly after Chocolatey is installed and prior to installing `chocolatey.extension` and `chocolatey-agent`.

The order for scripting is this:
* chocolatey
* chocolatey-license
* chocolatey.extension
* chocolatey-agent

If items are installed in any other order, it could have strange effects or fail.
  &lt;/description&gt;
    &lt;!-- &lt;releaseNotes&gt;__REPLACE_OR_REMOVE__MarkDown_Okay&lt;/releaseNotes&gt; --&gt;
  &lt;/metadata&gt;
  &lt;files&gt;
    &lt;file src=&quot;tools\**&quot; target=&quot;tools&quot; /&gt;
  &lt;/files&gt;
&lt;/package&gt;
&quot;@@  | Out-File -FilePath &quot;$licensePackageNuspec&quot; -Encoding UTF8 -Force

# Package up everything
Write-Output &quot;Creating a package&quot;
choco pack $licensePackageNuspec --output-directory=&quot;$packagesFolder&quot;

Write-Output &quot;Package has been created and is ready at $packagesFolder&quot;</code></pre>
<h2 id="exercise-5-push-a-package-to-the-repository">Exercise 5: Push A Package To The Repository</h2>
<p>We need to ensure the repository is all set up correctly, the best way to test that is to push a package to the repository (and to test installation, which will do in the next exercise).</p>
<ol>
<li>So now we&#39;ll take that package we created in the previous exercise and push it to the server.</li>
<li>Open PowerShell.exe (does not need to be admin).</li>
<li>Run <code>choco push $env:SystemDrive\choco-setup\packages\chocolatey-license.1.0.0.nupkg --source=&quot;'http://localhost/chocolatey'&quot; --api-key=&quot;'&lt;insert api key&gt;'&quot;</code> (url is different for different source repository types)</li>
<li>If you get an error about insecure channels, &quot;The specified source &#39;&#39; is not secure&quot;, and you are all inside an internal network, you can add <code>--force</code> to the end of the command above.</li>
<li>If you have not already placed a package with this name/version, it should be successful. If it is not, you need to revisit earlier exercises to determine if you missed a step.</li>
</ol>
<p><strong>NOTE</strong>: If you are using open source Chocolatey, you will want to create a test package using <code>choco new</code> and use that to push and verify setup.</p>
<h2 id="exercise-6-installing-chocolatey-on-client-machines">Exercise 6: Installing Chocolatey On Client Machines</h2>
<p>So now we&#39;ll install Chocolatey using all internal resources and configure Chocolatey so that it doesn&#39;t use any external sources or resources. If we&#39;ve set up everything properly prior to this, this will be a breeze. If not, we are going to need to visit previous exercises to fix what we may have missed.</p>
<h3 id="exercise-6a-installing-chocolatey-on-clients-directly-using-powershell">Exercise 6A: Installing Chocolatey On Clients Directly Using PowerShell</h3>
<p>Starting with Chocolatey.Server v0.2.3, you get a similar experience where you just open an Administrative PowerShell.exe and follow the instructions like you see at <a href="https://chocolatey.org/install" class="uri">https://chocolatey.org/install</a>. This ease of install is very beneficial when setting up client machines directly.</p>
<p><strong>NOTE:</strong> Perform the following steps on a different machine, not on the machine where you&#39;ve already set up Chocolatey or a repository.</p>
<ol>
<li>From the client machine (not the same machine you just set up the repository on), open a browser and navigate to the url of the package repository you just set up.</li>
<li>On that page it will contain instructions on how to install. Follow those instructions and that will set up the client (Chocolatey.Server v0.2.2+ ONLY).</li>
<li>If you don&#39;t have that, you will need to use the local script pointed to download from the bare nupkg url that is available for chocolatey.nupkg (which we gathered in Exercise 0).</li>
<li>Open PowerShell.exe as an administrative shell. You can type &quot;Windows Key + X + A&quot; (Windows 8+ - when that comes up if it is cmd.exe, simply type <code>powershell</code> to get into it).</li>
<li>If you need FIPS compliance, run <code>choco feature enable --name=&quot;'useFipsCompliantChecksums'&quot;</code>.</li>
<li>Run <code>choco source remove --name=&quot;'chocolatey'&quot;</code> to remove the default community package repository.</li>
<li>Run <code>choco source add --name=&quot;'internal_server'&quot; --source=&quot;'$baseUrl/chocolatey'&quot; --priority=&quot;'1'&quot; &lt;other options&gt;</code>. Other options noted at <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "commands-source" })">source command</a>.</li>
<li>C4B / MSP / TRIAL: Install the license package we&#39;ve pushed - <code>choco upgrade chocolatey-license -y</code>. This may be a place you see an error if things are not configured correctly. If you run into an error, be sure that you have the source added properly with the right permissions (not api key - that is for pushes only).</li>
<li>C4B / MSP / TRIAL: Run <code>choco source disable --name=&quot;'chocolatey.licensed'&quot;</code>. When the license is placed, Chocolatey automatically adds the license and we don&#39;t want to use that source. Note we can&#39;t remove the license because the existence of the license file will have Chocolatey adding it right back - so we just disable it. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and we are going to take care of that in the next step.</li>
<li>C4B / MSP / TRIAL: Run <code>choco upgrade chocolatey.extension -y --pre</code>. You will see what looks like an error message about not having chocolatey.extension installed. That&#39;s a warning and should clear up when this command completes.</li>
<li>Run <code>choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache</code>. This moves the TEMP location in scripts to use this and makes clean up more deterministic.</li>
<li>Run <code>choco config set commandExecutionTimeoutSeconds 14400</code>. This increases the timeout more than the default 45 minutes, you may wish to set it higher.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'internalizeAppendUseOriginalLocation'&quot;</code>. This sets Package Internalizer to append <code>-UseOriginalLocation</code> to the end of <code>Install-ChocolateyPackage</code> to make it behave more like <code>Install-ChocolateyInstallPackage</code>. Since the files are local, we won&#39;t need it copying them to temp prior to running it.</li>
<li>C4B / MSP / TRIAL: Run <code>choco feature enable --name=&quot;'reduceInstalledPackageSpaceUsage'&quot;</code> to ensure Package Reducer is turned on.</li>
<li>Set proxy configuration, virus scan configuration, or other configuration as described at <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "chocolatey-configuration" })">Chocolatey configuration</a>.</li>
<li>C4B / MSP / TRIAL: Are we installing the <a href="https://chocolatey.org/docs/features-agent-service#setup">optional Chocolatey Agent Service as well</a>? If so, run <code>choco upgrade chocolatey-agent -y --pre</code> and then follow the link for other settings you will need to configure.</li>
</ol>
<pre><code class="powershell"># This is a base url and should not include the &quot;/chocolatey&quot; (for Chocolatey.Server) or any url path to a NuGet/Chocolatey Packages API
$baseUrl = &quot;http://localhost&quot;
# this is the sub path, it will combine the above with this in the script $baseUrl/$repositoryUrlPath
$repositoryUrlPath = &quot;chocolatey&quot;

# Ensure we can run everything
Set-ExecutionPolicy Bypass -Scope Process -Force;

# Reroute TEMP to a local location
New-Item $env:ALLUSERSPROFILE\choco-cache -ItemType Directory -Force
$env:TEMP = &quot;$env:ALLUSERSPROFILE\choco-cache&quot;

# Ignore proxies since we are using internal locations
$env:chocolateyIgnoreProxy = &#39;true&#39;
# Set proxy settings if necessary
#$env:chocolateyProxyLocation = &#39;https://local/proxy/server&#39;
#$env:chocolateyProxyUser = &#39;username&#39;
#$env:chocolateyProxyPassword = &#39;password&#39;

# Install Chocolatey
# This is for use with Chocolatey.Server only:
iex ((New-Object System.Net.WebClient).DownloadString(&quot;$baseUrl/install.ps1&quot;))
# You&#39;ll need to also use the script you used for local installs to get Chocolatey installed.

# Are you military, government, or for some other reason have FIPS compliance turned on?
#choco feature enable --name=&quot;&#39;useFipsCompliantChecksums&#39;&quot;

# Sources - Remove community repository
choco source remove --name=&quot;&#39;chocolatey&#39;&quot;

# Sources - Add your internal repositories
# This is Chocolatey.Server specific (add other options like auth/allow self service as needed - https://chocolatey.org/docs/commands-source):
choco source add --name=&quot;&#39;internal_server&#39;&quot; --source=&quot;&#39;$baseUrl/$repositoryUrlPath&#39;&quot; --priority=&quot;&#39;1&#39;&quot; --bypass-proxy
#TODO: Add other sources here

# Add license to setup and to local install
choco upgrade chocolatey-license -y

# Sources - Disable licensed source
choco source disable --name=&quot;&#39;chocolatey.licensed&#39;&quot;
Write-Host &quot;You can ignore the red text in the output above, as it is more of a warning until we have chocolatey.extension installed&quot;

# Install Chocolatey Licensed Extension
choco upgrade chocolatey.extension -y --pre

# Set Configuration
choco config set cacheLocation $env:ALLUSERSPROFILE\choco-cache
choco config set commandExecutionTimeoutSeconds 14400
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration

# Set Licensed Configuration
choco feature enable --name=&quot;&#39;internalizeAppendUseOriginalLocation&#39;&quot;
choco feature enable --name=&quot;&#39;reduceInstalledPackageSpaceUsage&#39;&quot;
#TODO: Add other items you would configure here
# https://chocolatey.org/docs/chocolatey-configuration

#TODO: Are we installing the Chocolatey Agent Service?
# https://chocolatey.org/docs/features-agent-service#setup
# choco upgrade chocolatey-agent -y --pre
#choco feature disable --name=&quot;&#39;showNonElevatedWarnings&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundService&#39;&quot;
#choco feature enable --name=&quot;&#39;useBackgroundServiceWithNonAdministratorsOnly&#39;&quot;
#TODO: Check out other options and features to set at the url above.
#TODO: Also make sure you set your sources to allow for self-service</code></pre>
<h3 id="exercise-6b-installing-chocolatey-on-clients-with-infrastructure-management-tools">Exercise 6B: Installing Chocolatey On Clients with Infrastructure Management Tools</h3>
<p>This is likely to vary somewhat wildly based on what you have set up. We recommend choosing a tool and then looking at what is available.</p>
<p>We have documentation for Puppet at <a href="https://chocolatey.org/docs/installation-licensed#set-up-licensed-edition-with-puppet" class="uri">https://chocolatey.org/docs/installation-licensed#set-up-licensed-edition-with-puppet</a>, with some great examples. What you would do to make that work with Ansible, Chef, Salt, or PowerShell DSC would be similar. All of the different options are covered at <a href="@Url.RouteUrl(RouteName.Docs, new { docName = "features-infrastructure-automation" })">Infrastructure Management Integration</a>.</p>
<p>If you are using Chocolatey.Server, please login to that machine and check <a href="https://localhost" class="uri">https://localhost</a> for instructions specific to different infrastructure management tools in the admin section.</p>
<h4 id="chocolatey-integration-implementation-with-configuration-managers">Chocolatey Integration Implementation with Configuration Managers</h4>
<p>For common integrations, it&#39;s handy to refer to the table below to know what configuration manager to choose. Most of the implementations below are written and managed by the companies behind the product. These implementations are typically open source and each part could be added by community contributions for those familiar with the code implementations. If you are unable to provide code implementations for adding necessary functionality to the integrations, we find it best if you create issues/tickets with those organizations if you are a customer as you will have more leverage into getting them implemented. <strong>NOTE</strong>: If you are a configuration manager company identified in the table and you have implemented anything in the below or you find our information is incorrect, please let us know so we can get it fixed.</p>
<table>
<thead>
<tr class="header">
<th></th>
<th><a href="http://docs.ansible.com/ansible/latest/modules/win_chocolatey_module.html">Ansible</a></th>
<th><a href="https://docs.chef.io/resource_chocolatey_package.html">Chef</a> / <a href="https://supermarket.chef.io/cookbooks/chocolatey/">Cookbook</a></th>
<th><a href="https://www.powershellgallery.com/packages/cChoco/2.3.1.0">PowerShell DSC</a></th>
<th><a href="https://forge.puppet.com/puppetlabs/chocolatey">Puppet</a></th>
<th><a href="https://docs.saltstack.com/en/latest/ref/modules/all/salt.modules.chocolatey.html">Salt</a></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Manage Packages</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
<tr class="even">
<td><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "installation" })">Install Chocolatey</a></td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
<td>x</td>
</tr>
<tr class="odd">
<td>Install Chocolatey from internal source</td>
<td></td>
<td>x</td>
<td>x</td>
<td>x</td>
<td></td>
</tr>
<tr class="even">
<td><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "commands-source" })">Manage Sources</a></td>
<td></td>
<td></td>
<td>x</td>
<td>x</td>
<td></td>
</tr>
<tr class="odd">
<td>Manage Source Type (Admin/Self-Service)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "commands-feature" })">Manage Features</a></td>
<td></td>
<td></td>
<td>x</td>
<td>x</td>
<td></td>
</tr>
<tr class="odd">
<td><a href="@Url.RouteUrl(RouteName.Docs, new { docName = "commands-config" })">Manage Config Settings</a></td>
<td></td>
<td></td>
<td></td>
<td>x</td>
<td></td>
</tr>
</tbody>
</table>
<p>For most of these, those configuration managers have some sort of exec you could use to manage those additional aspects, but it would be best if they supported all aspects of configuration of Chocolatey as part of the provider implementations.</p>
<h2 id="exercise-7-subscribe-to-release-announcements">Exercise 7: Subscribe To Release Announcements</h2>
<p>In a fully internal environment, you need a way to know when new versions have been released and if they affect you so you can update those packages in your environment. Best to have a low traffic announce only type of email list you can join. Fortunately there is - <code>chocolatey-announce</code>.</p>
<p>You can sign up for email delivery of new release announcements at <a href="https://groups.google.com/forum/#!forum/chocolatey-announce">chocolatey-announce</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>If you&#39;ve made it this far, you are ready to be quite successful with Chocolatey and Windows automation in your organization. If you are using open source Chocolatey, from time to time you might check in to see what we&#39;ve been adding to the <a href="https://chocolatey.org/compare#compare">commercial options</a>. We are building a complete software management solution with Chocolatey for Business, above and beyond the package management that Chocolatey open source does.</p>
<h2 id="next-steps">Next Steps</h2>
<p>Now it&#39;s time to take the next steps and learn about Chocolatey and packaging itself:</p>
<ul>
<li><a href="https://github.com/ferventcoder/chocolatey-workshop">Learn How To Build Packages</a></li>
<li><a href="https://github.com/ferventcoder/chocolatey-workshop">Learn Basic and Advanced Concepts For Software Management with Chocolatey</a></li>
<li><a href="https://chocolatey.org/docs">Chocolatey Documentation</a></li>
<li><a href="https://chocolatey.org/compare#compare">Compare Features In Different Editions</a></li>
</ul>
</article>
